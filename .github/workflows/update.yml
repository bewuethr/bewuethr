name: Update README

on:
  workflow_dispatch:
    inputs:
      location:
        description: Update city for which to look up weather
        type: string
        required: false
      timezone:
        description: Update timezone to figure out time of day
        type: string
        required: false
      holiday:
        description: Enable holiday mode
        type: boolean
        required: false
        default: false
  schedule:
    - cron: 5 * * * *

jobs:
  update:
    name: Update README
    runs-on: ubuntu-22.04
    steps:
      - name: Check out repository
        uses: actions/checkout@v3.5.0

      - name: Set location, timezone, and holiday status
        id: metadata
        env:
          location: ${{ inputs.location }}
          timezone: ${{ inputs.timezone }}
          holiday: ${{ inputs.holiday }}
        run: |
          mdfile='.github/updater/metadata.yml'

          if [[ -n $location ]]; then
              yq --inplace '.location = env(location)' "$mdfile"
          else
              location=$(yq '.location' "$mdfile")
          fi

          if [[ -n $timezone ]]; then
              yq --inplace '.timezone = env(timezone)' "$mdfile"
          else
              timezone=$(yq '.timezone' "$mdfile")
          fi

          if [[ -n $holiday ]]; then
              yq --inplace '.holiday = env(holiday)' "$mdfile"
          else
              holiday=$(yq '.holiday' "$mdfile")
          fi

          printf '%s\n' \
              "location=$location" \
              "timezone=$timezone" \
              "holiday=$holiday" \
              >> "$GITHUB_OUTPUT"

      - name: Run updater
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          TZ: ${{ steps.metadata.outputs.timezone }}
          location: ${{ steps.metadata.outputs.location }}
          holiday: ${{ steps.metadata.outputs.holiday }}
        run: .github/workflows/updater "$location" "$holiday"
