#!/usr/bin/env bash

leisure=(
	'fiddling with my [dotfiles](https://github.com/bewuethr/dotfiles)'
	'finally adding refraction to my [terminal raytracer](https://github.com/bewuethr/bash-raytracer)'
	'polishing my [static site generator](https://github.com/bewuethr/pandoc-bash-blog)'
	'crafting a fascinating [blog post](https://www.benjaminwuethrich.dev)'
)

work=(
	'clicking some merge buttons'
	'moving some Jira tickets'
	'reviewing some pull requests'
	'interviewing a potential new colleague'
	'making a service more micro'
)
work=("${work[@]/#/'working for [this bunch](https://github.com/kohofinancial), '}")


updatestatus() {
	local emoji=$1
	gh api graphql --raw-field query='
		mutation UpdateStatusEmoji {
		  changeUserStatus(input:{emoji:"'"$emoji"'"}) {
		   clientMutationId
		   status {
			 emoji
			 updatedAt
			 user {
			   login
			 }
		   }
		 }
	  }
	' | jq .
}

update() {
	local weekday hour
	read -r weekday hour <<< "$(date '+%A %-H')"

	local activity emoji
	case $hour in
		[0-7])
			activity="I'm probably sleeping."
			emoji=':sleeping:'
			;;
		1[89] | 2[0-3])
			activity="I might be ${leisure[RANDOM % ${#leisure[@]}]}."
			emoji=':man_juggling:'
			;;
		*)
			case $weekday in
				Saturday | Sunday)
					activity="I might be ${leisure[RANDOM % ${#leisure[@]}]}."
					emoji=':joystick:'
					;;
				*)
					activity="I'm probably ${work[RANDOM % ${#work[@]}]}."
					emoji=':nerd_face:'
					;;
			esac
			;;
	esac

	echo "Updating README with $weekday and $activity..."
	cat <<- EOF > README.md
		### Hi there :wave:

		It's $weekday! $activity
	EOF

	echo "Updating profile status with $emoji..."
	updatestatus "$emoji"
}

push() {
	# Set git name and email
	git config --global user.name 'github-actions'
	git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'

	if [[ -n $(git status --porcelain) ]]; then
		echo "Change detected; pushing new README..."
		git add README.md
		git commit --message 'Update README'
		git push
	fi
}

main() {
	update
	push
}

[[ ${BASH_SOURCE[0]} == "$0" ]] && main
