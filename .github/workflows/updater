#!/usr/bin/env bash

leisure=(
	'fiddling with my [dotfiles](https://github.com/bewuethr/dotfiles)'
	'finally adding refraction to my [terminal raytracer](https://github.com/bewuethr/bash-raytracer)'
	'polishing my [static site generator](https://github.com/bewuethr/pandoc-bash-blog)'
	'crafting a fascinating [blog post](https://benjaminwuethrich.dev)'
	'watching [YouTube videos about relay computers](https://youtube.com/playlist?list=PL_1HsIiuOfg3QA91DUd9kGJjQoOHwlt5Q)'
	'reading a [book](https://www.goodreads.com/review/list/37130358-benjamin?ref=nav_mybooks&shelf=currently-reading)'
	'tweaking my [Slack workspace analyzer action](https://github.com/bewuethr/slack-analyzer)'
	'fighting with Jekyll to make [this](https://swissclubto.github.io) better'
	'putting some [miles](https://www.strava.com/athletes/889963) in'
)

work=(
	'clicking some merge buttons'
	'moving some Jira tickets'
	'reviewing some pull requests'
	'interviewing a potential new colleague'
	'making a service more micro'
	'overthrowing the banking establishment'
	'maintaining a Git mailmap'
	'figuring out who should take care of which service'
	'de-flaking a test'
	'polishing a command line interface'
	'making a reusable workflow more reusable'
	'lighting a fire under some Jenkins pipeline'
)
work=("${work[@]/#/'working for [this bunch](https://github.com/kohofinancial), '}")

getweather() {
	local -n w=$1
	local location=$2
	# shellcheck disable=SC2034
	readarray -t w < <(
		curl --silent --get "wttr.in/${location// /+}" \
			--data-urlencode 'm' \
			--data-urlencode 'lang=en' \
			--data-urlencode 'format=%C\n%t\n'
	)
}

updatestatus() {
	local emoji=$1
	local status=$2
	gh api graphql \
		--raw-field query='
			mutation UpdateStatus{
			  changeUserStatus(input:{emoji:"'"$emoji"'",message:"'"$status"'"}) {
			    clientMutationId
			    status {
			      emoji
			      message
			      updatedAt
			      user {
			        login
			      }
			    }
			  }
			}
		' | jq .
}

update() {
	local location=$1
	local holiday=$2
	local weekday hour
	read -r weekday hour <<< "$(date '+%A %-H')"

	local mode activity emoji status

	# Determine if I'm sleeping, working, or doing a leisure activity
	case $hour in
		[0-7]) mode='sleeping' ;;
		1[89] | 2[0-3]) mode='leisure' ;;
		*)
			if [[ $holiday == 'true' ]]; then
				mode='leisure'
			else
				case $weekday in
					Saturday | Sunday) mode='leisure' ;;
					*) mode='working' ;;
				esac
			fi
			;;
	esac

	case $mode in
		sleeping)
			activity="I'm probably sleeping."
			emoji=':sleeping:'
			status='Snoozing'
			;;
		working)
			activity="I'm probably ${work[RANDOM % ${#work[@]}]}."
			emoji=':nerd_face:'
			status='Work work work'
			;;
		leisure)
			activity="I might be ${leisure[RANDOM % ${#leisure[@]}]}."
			case $weekday in
				Saturday | Sunday)
					emoji=':joystick:'
					status='Playing'
					;;
				*)
					emoji=':man_juggling:'
					status='Juggling'
					;;
			esac
			;;
	esac

	local weather
	getweather weather "$location"

	if [[ $holiday == 'true' ]]; then
		printf -v activity '%s %s' "And I'm on holiday! :desert_island:" "$activity"
	fi

	if [[ ${weather[*]} == 'Unknown location'* ]]; then
		echo "Updating README with $weekday and $activity, weather unknown..."
		cat <<- EOF > README.md
			### Hi there :wave:

			It's $weekday! $activity

			Weather in $location: who knows, wttr.in is currently down...
		EOF
	else
		echo "Updating README with $weekday and $activity, weather ${weather[*]}..."
		cat <<- EOF > README.md
			### Hi there :wave:

			It's $weekday! $activity

			Weather in $location: ${weather[0],}, at ${weather[1]}.
		EOF
	fi

	# Don't change status when I'm on holiday, it's probably a message about
	# when I'll be back
	if [[ $holiday != 'true' ]]; then
		echo "Updating profile status with $emoji and $status..." >&2
		updatestatus "$emoji" "$status"
	fi
}

push() {
	# Set git name and email
	git config --global user.name 'github-actions'
	git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'

	if [[ -n $(git status --porcelain) ]]; then
		echo "Change detected; pushing new README..."
		git add README.md .github/updater/metadata.yml
		git commit --message 'Update README and maybe metadata'
		git push
	fi
}

main() {
	local location=$1
	local holiday=$2
	update "$location" "$holiday"
	push
}

[[ ${BASH_SOURCE[0]} == "$0" ]] && main "$@"
